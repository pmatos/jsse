# ECMA-402 (Intl) Full Compliance Design

## Overview

Full ECMA-402 internationalization support for JSSE using ICU4X with compiled CLDR data for all locales. Covers all 11 Intl constructors, shared abstract operations, locale-aware overrides for built-in prototypes, and Temporal intl integration.

## Decisions

- **ICU library**: ICU4X (`icu` crate v2.0) — Rust-native, no C dependencies
- **Data strategy**: Compiled-in (baked data) — zero runtime dependencies, tests work anywhere
- **Locale coverage**: Full CLDR — all locales included
- **Scope**: Full ECMA-402 including Temporal intl (3,220 test262 tests total)

## Architecture

### Module Structure

```
src/interpreter/builtins/intl/
├── mod.rs                # Intl namespace, shared abstract operations (§9)
├── locale.rs             # Intl.Locale
├── collator.rs           # Intl.Collator
├── numberformat.rs       # Intl.NumberFormat
├── datetimeformat.rs     # Intl.DateTimeFormat
├── pluralrules.rs        # Intl.PluralRules
├── relativetimeformat.rs # Intl.RelativeTimeFormat
├── listformat.rs         # Intl.ListFormat
├── segmenter.rs          # Intl.Segmenter + Segments + SegmentIterator
├── displaynames.rs       # Intl.DisplayNames
└── durationformat.rs     # Intl.DurationFormat
```

Each file: `impl Interpreter { pub(crate) fn setup_intl_XXX(...) }`, following existing builtin pattern.

### Dependencies

```toml
icu = "2.0"  # Umbrella crate: locale, collator, decimal, datetime, plurals, list, segmenter, displaynames, relativetime, casemap, normalizer + compiled data
```

### Internal Slots (Data Model)

Each Intl object stores resolved options + cached ICU4X formatter via an `IntlData` enum on the object struct:

```rust
enum IntlData {
    Locale { locale: icu::locale::Locale },
    Collator { locale, options, collator: icu::collator::Collator },
    NumberFormat { locale, options, formatter },
    DateTimeFormat { locale, options, formatter },
    PluralRules { locale, plural_type, rules: icu::plurals::PluralRules },
    RelativeTimeFormat { locale, options, formatter },
    ListFormat { locale, options, formatter: icu::list::ListFormatter },
    Segmenter { locale, granularity, segmenter },
    DisplayNames { locale, options, formatter },
    DurationFormat { locale, options, formatter },
}
```

ICU4X formatters are pure Rust — no GC interaction needed. Dropped when JS object is collected.

### Shared Abstract Operations (§9)

All in `intl/mod.rs`:

- `CanonicalizeLocaleList(locales)` — validate/canonicalize via `icu::locale::Locale::try_from_str()`
- `BestAvailableLocale(availableLocales, locale)` — prefix matching
- `LookupMatcher` / `BestFitMatcher` — locale negotiation
- `ResolveLocale(available, requested, options, extensions, data)` — core negotiation
- `LookupSupportedLocales` / `BestFitSupportedLocales` — locale filtering
- `SupportedLocales(available, requested, options)` — public filtering API
- `GetOption` / `GetStringOption` / `GetNumberOption` / `CoerceOptionsToObject` — option extraction

## Implementation Phases

### Phase 0: Infrastructure
- Add `icu = "2.0"` dependency
- Create `intl/mod.rs` with shared abstract operations
- Register `Intl` namespace on global scope
- `Intl.getCanonicalLocales()`, `Intl.supportedValuesOf()`
- **Target**: 66 + 22 = ~88 tests

### Phase 1: Intl.Locale
- Constructor, prototype getters (baseName, calendar, caseFirst, collation, hourCycle, language, numberingSystem, numeric, region, script)
- `maximize()`, `minimize()`, `toString()`
- **ICU4X**: `icu::locale::Locale`, `icu::locale::LocaleExpander`
- **Target**: 152 tests

### Phase 2: Intl.Collator
- Constructor, `compare()`, `resolvedOptions()`, `supportedLocalesOf()`
- **ICU4X**: `icu::collator::Collator`
- **Target**: 65 tests

### Phase 3: Intl.NumberFormat
- Constructor, `format()`, `formatToParts()`, `formatRange()`, `formatRangeToParts()`, `resolvedOptions()`
- Styles: decimal, currency, percent, unit
- **ICU4X**: `icu::decimal::DecimalFormatter`
- **Target**: 253 + 18 override tests

### Phase 4: Intl.DateTimeFormat
- Constructor, `format()`, `formatToParts()`, `formatRange()`, `formatRangeToParts()`, `resolvedOptions()`
- dateStyle/timeStyle + individual component options
- **ICU4X**: `icu::datetime::DateTimeFormatter`
- **Target**: 231 + 12 override tests

### Phase 5: Intl.PluralRules
- Constructor, `select()`, `selectRange()`, `resolvedOptions()`
- Types: cardinal, ordinal
- **ICU4X**: `icu::plurals::PluralRules`
- **Target**: 52 tests

### Phase 6: Intl.RelativeTimeFormat
- Constructor, `format()`, `formatToParts()`, `resolvedOptions()`
- **ICU4X**: `icu::relativetime::RelativeTimeFormatter`
- **Target**: 80 tests

### Phase 7: Intl.ListFormat
- Constructor, `format()`, `formatToParts()`, `resolvedOptions()`
- Types: conjunction, disjunction, unit. Styles: long, short, narrow
- **ICU4X**: `icu::list::ListFormatter`
- **Target**: 81 tests

### Phase 8: Intl.Segmenter
- Constructor, `segment()` → Segments object
- `Segments[@@iterator]()`, `containing()`
- **ICU4X**: `icu::segmenter::{GraphemeClusterSegmenter, WordSegmenter, SentenceSegmenter}`
- **Target**: 79 tests

### Phase 9: Intl.DisplayNames
- Constructor, `of()`, `resolvedOptions()`
- Types: language, region, script, calendar, dateTimeField, currency
- **ICU4X**: `icu::displaynames::*`
- **Target**: 57 tests

### Phase 10: Intl.DurationFormat
- Constructor, `format()`, `formatToParts()`, `resolvedOptions()`
- **ICU4X**: duration formatting
- **Target**: 111 tests

### Phase 11: Locale-aware Prototype Overrides
- `String.prototype.localeCompare()` → Collator
- `String.prototype.toLocaleLowerCase/toLocaleUpperCase()` → `icu::casemap`
- `Number.prototype.toLocaleString()` → NumberFormat
- `BigInt.prototype.toLocaleString()` → NumberFormat
- `Date.prototype.toLocaleString/toLocaleDateString/toLocaleTimeString()` → DateTimeFormat
- `Array.prototype.toLocaleString()` → element toLocaleString
- **Target**: ~52 override tests

### Phase 12: Temporal Intl Integration
- `Temporal.*.prototype.toLocaleString()` for all Temporal types
- **Target**: 1,919 tests

## Test Runner Integration

- Run intl402 tests: `uv run python scripts/run-test262.py test262/test/intl402/`
- Add feature flags incrementally as constructors are implemented
- Each phase validated by running its corresponding test262 subdirectory

## Total Test Target

~3,220 test files across all phases. Combined with existing 92.33% pass rate on core tests, full intl402 compliance significantly expands the engine's coverage.
